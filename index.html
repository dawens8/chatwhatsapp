<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>2-Number Live Chat & Call</title>
<style>
body{font-family: Arial,sans-serif; display:flex; justify-content:center; background:#0c1515; color:white; margin:0; height:100vh;}
.container{width:90%; max-width:1200px; background:#1a1f22; padding:20px; border-radius:10px; display:flex; flex-direction:column; height:95vh;}
.hidden{display:none;}
input, button{padding:10px; margin:5px 0; border-radius:5px; border:none;}
#chatBox{flex:1; background:#111; overflow:auto; padding:10px; border-radius:5px; display:flex; flex-direction:column; margin-bottom:10px; font-size:1.2em;}
.bubble{padding:12px 16px; border-radius:12px; margin:5px 0; max-width:70%; font-size:1em;}
.sent{background:#25D366; color:#000; align-self:flex-end;}
.rec{background:#fff; color:#000; align-self:flex-start;}
.header{display:flex; align-items:center; margin-bottom:10px; font-size:1.3em;}
.header img{width:60px; height:60px; border-radius:50%; margin-right:15px;}
.callStatus{margin:10px 0; color:#0f0; font-size:1.5em;}
.chat-controls{display:flex; gap:5px;}
.chat-controls input{flex:1; font-size:1.2em; padding:12px;}
.fullScreenCall{position:fixed; top:0; left:0; width:100%; height:100%; background:#000; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;}
.fullScreenCall button{margin:10px; padding:15px; font-size:1.3em; border-radius:10px; background:#25D366; color:#000; border:none; cursor:pointer;}
.fullScreenCall audio{margin-top:20px;}
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="container">

  <div id="loginArea">
    <h2>Login with your number</h2>
    <input type="text" id="numberInput" placeholder="Enter your number"/>
    <button id="sendCodeBtn">Send Code</button>
    <div id="codeArea" class="hidden">
      <input type="text" id="codeInput" placeholder="Enter code"/>
      <button id="verifyBtn">Verify</button>
    </div>
    <div id="loginStatus"></div>
  </div>

  <div id="chatArea" class="hidden">
    <div class="header">
      <img id="profileImg" src="" alt="Profile"/>
      <div>
        <div id="profileName"></div>
        <small>Online</small>
      </div>
    </div>
    <div id="chatBox"></div>

    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Type message..."/>
      <button id="sendBtn">Send</button>
      <button id="recordBtn">ðŸŽ¤</button>
      <button id="callBtn">ðŸ“ž Call</button>
    </div>
    <div id="callStatus" class="callStatus hidden"></div>
  </div>

</div>

<!-- Fullscreen Call Overlay -->
<div id="fullCallScreen" class="fullScreenCall hidden">
  <h1 id="callFrom">Incoming Call</h1>
  <button id="answerCallBtn">Answer</button>
  <button id="declineCallBtn">Decline</button>
  <button id="hangupBtn" class="hidden">Hang Up</button>
  <button id="muteBtn" class="hidden">Mute</button>
  <audio id="callAudio" autoplay></audio>
</div>

<script>
const socket = io();
const allowedNumbers = ['13058962443','18573917861'];
const profiles = {
  "13058962443": {name:"My Wife", photo:"https://via.placeholder.com/60x60?text=W"},
  "18573917861": {name:"Me", photo:"https://via.placeholder.com/60x60?text=Me"}
};
let myNumber = null;
let verificationCode = null;
let otherNumber = null;

const loginArea = document.getElementById('loginArea');
const codeArea = document.getElementById('codeArea');
const loginStatus = document.getElementById('loginStatus');
const numberInput = document.getElementById('numberInput');
const sendCodeBtn = document.getElementById('sendCodeBtn');
const codeInput = document.getElementById('codeInput');
const verifyBtn = document.getElementById('verifyBtn');

const chatArea = document.getElementById('chatArea');
const chatBox = document.getElementById('chatBox');
const profileImg = document.getElementById('profileImg');
const profileName = document.getElementById('profileName');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const callBtn = document.getElementById('callBtn');
const callStatus = document.getElementById('callStatus');
const recordBtn = document.getElementById('recordBtn');

const fullCallScreen = document.getElementById('fullCallScreen');
const callFrom = document.getElementById('callFrom');
const answerCallBtn = document.getElementById('answerCallBtn');
const declineCallBtn = document.getElementById('declineCallBtn');
const hangupBtn = document.getElementById('hangupBtn');
const muteBtn = document.getElementById('muteBtn');
const callAudio = document.getElementById('callAudio');

// Login & verification
sendCodeBtn.onclick = ()=>{
  const num = numberInput.value.trim();
  if(!allowedNumbers.includes(num)) return alert("Number not allowed!");
  myNumber = num;
  otherNumber = allowedNumbers.find(n=>n!==myNumber);
  verificationCode = Math.floor(1000+Math.random()*9000);
  alert("Your verification code: "+verificationCode);
  codeArea.classList.remove('hidden');
}

verifyBtn.onclick = ()=>{
  if(codeInput.value.trim()==verificationCode){
    loginStatus.textContent="Verified! Access granted.";
    loginArea.classList.add('hidden');
    chatArea.classList.remove('hidden');
    profileImg.src = profiles[otherNumber].photo;
    profileName.textContent = profiles[otherNumber].name;
    socket.emit('join', myNumber);
  } else alert("Incorrect code!");
}

// Text message
sendBtn.onclick = ()=>{
  const txt = messageInput.value.trim();
  if(!txt) return;
  const msg = {to: otherNumber,text: txt};
  socket.emit('message', msg);
  messageInput.value='';
}

messageInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')sendBtn.click();});

// Receive text
socket.on('message', msg=>{
  const div = document.createElement('div');
  div.className='bubble '+(msg.from===myNumber?'sent':'rec');
  div.innerHTML=`<div>${msg.text}</div><div style="font-size:12px;color:#aaa">${msg.from} â€¢ ${msg.time}</div>`;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Voice
let mediaRecorder;
let audioChunks = [];
recordBtn.onclick = async ()=>{
  if(!mediaRecorder || mediaRecorder.state==="inactive"){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(audioChunks, {type:'audio/webm'});
      audioChunks=[];
      const reader = new FileReader();
      reader.onloadend = ()=>{
        socket.emit('voice', {to:otherNumber, audio:reader.result});
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    recordBtn.textContent="â¹";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent="ðŸŽ¤";
  }
};

socket.on('voice', msg=>{
  const audio = document.createElement('audio');
  audio.controls = true;
  audio.src = msg.audio;
  const div = document.createElement('div');
  div.className='bubble '+(msg.from===myNumber?'sent':'rec');
  div.appendChild(audio);
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Call
callBtn.onclick = ()=>{
  fullCallScreen.classList.remove('hidden');
  callFrom.textContent="Calling "+profiles[otherNumber].name;
  hangupBtn.classList.remove('hidden');
  muteBtn.classList.remove('hidden');
  socket.emit('call', {to:otherNumber});
}

// Incoming call
socket.on('incomingCall', data=>{
  fullCallScreen.classList.remove('hidden');
  callFrom.textContent="Incoming Call from "+profiles[otherNumber].name;
  answerCallBtn.classList.remove('hidden');
  declineCallBtn.classList.remove('hidden');
});

// Answer / Decline
answerCallBtn.onclick = ()=>{
  socket.emit('answerCall', {to:otherNumber});
  callFrom.textContent="Call connected with "+profiles[otherNumber].name;
  answerCallBtn.classList.add('hidden');
  declineCallBtn.classList.add('hidden');
  hangupBtn.classList.remove('hidden');
  muteBtn.classList.remove('hidden');
};
declineCallBtn.onclick = ()=>{
  socket.emit('declineCall', {to:otherNumber});
  fullCallScreen.classList.add('hidden');
};
hangupBtn.onclick = ()=> fullCallScreen.classList.add('hidden');
muteBtn.onclick = ()=> callAudio.muted = !callAudio.muted;

socket.on('callAnswered', data=>{
  callFrom.textContent="Call connected with "+profiles[otherNumber].name;
});
socket.on('callDeclined', data=>{
  callFrom.textContent="Call declined by "+profiles[otherNumber].name;
  setTimeout(()=> fullCallScreen.classList.add('hidden'),1500);
});
</script>
</body>
</html>
