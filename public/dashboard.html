<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Live Status & Video</title>
<style>
body{font-family:Arial; background:#0c1515; color:white; padding:20px;}
h2{margin-bottom:10px;}
.userCard{margin-bottom:20px; border:1px solid #444; padding:10px; border-radius:10px;}
video{width:300px; height:200px; background:#000; border-radius:8px;}
.online{color:#0f0;}
.offline{color:#f00;}
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h2>Live Status Dashboard</h2>
<div id="usersContainer"></div>

<script>
const socket = io();
const allowedNumbers = ['13058962443','18573917861'];
const usersContainer = document.getElementById('usersContainer');

let peers = {}; // store peer connections for each user

function renderUsers(users){
  usersContainer.innerHTML='';
  allowedNumbers.forEach(num=>{
    const div = document.createElement('div');
    div.className='userCard';
    const status = users[num]? 'Online':'Offline';
    div.innerHTML=`<h4>${num} - <span class="${users[num]?'online':'offline'}">${status}</span></h4>
    <video id="video-${num}" autoplay playsinline></video>`;
    usersContainer.appendChild(div);

    if(users[num] && num!==myNumber){
      // init WebRTC to get their video
      startVideo(num, users[num].socketId);
    }
  });
}

// WebRTC setup
let myStream;
let myNumber = prompt("Enter your number for dashboard view (13058962443 or 18573917861)");
navigator.mediaDevices.getUserMedia({video:true, audio:false}).then(stream=>{
  myStream = stream;
});

function startVideo(remoteNumber, remoteSocketId){
  if(peers[remoteNumber]) return;
  const pc = new RTCPeerConnection();
  peers[remoteNumber]=pc;

  // Add local video stream (optional for dashboard)
  if(myStream) myStream.getTracks().forEach(track=> pc.addTrack(track, myStream));

  pc.ontrack = e=>{
    const videoEl = document.getElementById('video-'+remoteNumber);
    videoEl.srcObject = e.streams[0];
  };

  pc.onicecandidate = e=>{
    if(e.candidate) socket.emit('webrtc-candidate',{to:remoteNumber,candidate:e.candidate});
  };

  // create offer
  pc.createOffer().then(offer=>{
    pc.setLocalDescription(offer);
    socket.emit('webrtc-offer',{to:remoteNumber,sdp:offer});
  });

  // signaling
  socket.on('webrtc-offer', data=>{
    if(data.from===remoteNumber){
      pc.setRemoteDescription(data.sdp).then(()=>{
        pc.createAnswer().then(answer=>{
          pc.setLocalDescription(answer);
          socket.emit('webrtc-answer',{to:data.from,sdp:answer});
        });
      });
    }
  });
  socket.on('webrtc-answer', data=>{
    if(data.from===remoteNumber){
      pc.setRemoteDescription(data.sdp);
    }
  });
  socket.on('webrtc-candidate', data=>{
    if(data.from===remoteNumber){
      pc.addIceCandidate(data.candidate);
    }
  });
}

// live status updates
socket.on('statusUpdate', users=>{
  renderUsers(users);
});
</script>
</body>
</html>
