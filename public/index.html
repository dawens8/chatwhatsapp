<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2-Number Chat & Call</title>
<style>
html, body{margin:0;padding:0;width:100%;height:100%;font-family:Arial,sans-serif;background:#0c1515;color:white;}
.container{width:95%;height:95%;margin:auto;background:#1a1f22;padding:20px;border-radius:12px;display:flex;flex-direction:column;}
.hidden{display:none;}
input,button{padding:12px;margin:5px 0;border-radius:8px;border:none;font-size:16px;}
#chatBox{flex:1;background:#111;overflow:auto;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;flex-direction:column;}
.bubble{padding:12px 16px;border-radius:12px;margin:8px 0;max-width:75%;font-size:18px;line-height:1.4;}
.sent{background:#25D366;color:#000;align-self:flex-end;}
.rec{background:#fff;color:#000;align-self:flex-start;}
.header{display:flex;align-items:center;margin-bottom:15px;}
.header img{width:60px;height:60px;border-radius:50%;margin-right:15px;}
.callStatus{margin:10px 0;color:#0f0;font-size:18px;}
.chat-controls{display:flex;gap:10px;flex-wrap:wrap;}
.chat-controls input{flex:1;}
button{cursor:pointer;font-weight:bold;}
#optionsMenu{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;}
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="container">

<div id="loginArea">
  <h2>Login with your number</h2>
  <input type="text" id="numberInput" placeholder="Enter your number"/>
  <button id="sendCodeBtn">Send Code</button>
  <div id="codeArea" class="hidden">
    <input type="text" id="codeInput" placeholder="Enter code"/>
    <button id="verifyBtn">Verify</button>
  </div>
  <div id="loginStatus"></div>
</div>

<div id="chatArea" class="hidden">
  <div class="header">
    <img id="profileImg" src="" alt="Profile"/>
    <div>
      <div id="profileName" style="font-size:22px;font-weight:bold;"></div>
      <small style="font-size:16px;">Online</small>
    </div>
  </div>

  <div id="chatBox"></div>

  <div class="chat-controls">
    <input type="text" id="messageInput" placeholder="Type message..."/>
    <button id="sendBtn">Send</button>
    <button id="recordBtn">üé§</button>
    <button id="callBtn">üìû Call</button>
    <button id="endCallBtn">‚ùå End</button>
    <button id="muteBtn">üîá Mute</button>
    <button id="speakerBtn">üîä Speaker</button>
  </div>

  <div id="optionsMenu">
    <input type="file" id="uploadPhoto" accept="image/*"/>
    <button id="deleteAllBtn">üóë Delete All</button>
    <button id="blockBtn">üö´ Block</button>
    <button id="reportBtn">‚ö†Ô∏è Report</button>
  </div>

  <div id="callStatus" class="callStatus hidden"></div>
</div>

</div>

<script>
const socket = io();
const allowedNumbers = ['13058962443','18573917861'];
const profiles = {
  "13058962443": {name:"My Wife", photo:"https://via.placeholder.com/60x60?text=W"},
  "18573917861": {name:"Me", photo:"https://via.placeholder.com/60x60?text=Me"}
};
let myNumber = null, verificationCode = null, otherNumber = null;
let inCall = false, muted=false, speaker=false;
let blocked = false;
let reports = JSON.parse(localStorage.getItem("reports") || "{}");

// --- AUDIO ---
const textTone = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
const ringTone = new Audio("https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg");
ringTone.loop = true;

// --- STORAGE KEYS ---
const STORAGE_KEY = "chatAppSession";
const PIN_KEY = "chatAppPIN";
const MSG_KEY = "chatAppMessages";

// --- DOM ---
const loginArea=document.getElementById('loginArea');
const codeArea=document.getElementById('codeArea');
const loginStatus=document.getElementById('loginStatus');
const numberInput=document.getElementById('numberInput');
const sendCodeBtn=document.getElementById('sendCodeBtn');
const codeInput=document.getElementById('codeInput');
const verifyBtn=document.getElementById('verifyBtn');

const chatArea=document.getElementById('chatArea');
const chatBox=document.getElementById('chatBox');
const profileImg=document.getElementById('profileImg');
const profileName=document.getElementById('profileName');
const messageInput=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const callBtn=document.getElementById('callBtn');
const callStatus=document.getElementById('callStatus');
const recordBtn=document.getElementById('recordBtn');
const endCallBtn=document.getElementById('endCallBtn');
const muteBtn=document.getElementById('muteBtn');
const speakerBtn=document.getElementById('speakerBtn');

const uploadPhoto=document.getElementById('uploadPhoto');
const deleteAllBtn=document.getElementById('deleteAllBtn');
const blockBtn=document.getElementById('blockBtn');
const reportBtn=document.getElementById('reportBtn');

// --- UTILS ---
function saveSession(number){
  const session = {number, verifiedAt: Date.now()};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
}
function loadSession(){
  const session = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
  if(session && (Date.now() - session.verifiedAt < 432000000)){ // 5 days
    return session;
  }
  return null;
}
function checkPIN(){
  const pin = localStorage.getItem(PIN_KEY);
  if(pin){
    const input = prompt("Enter your PIN:");
    if(input !== pin){ alert("Incorrect PIN!"); return false; }
  } else {
    const newPin = prompt("Set a new PIN:");
    if(newPin) localStorage.setItem(PIN_KEY, newPin);
  }
  return true;
}
function saveMessages(msgs){
  localStorage.setItem(MSG_KEY, JSON.stringify(msgs));
}
function loadMessages(){
  return JSON.parse(localStorage.getItem(MSG_KEY) || "[]");
}
function renderMessages(){
  chatBox.innerHTML="";
  const msgs=loadMessages();
  msgs.forEach(msg=>{
    const div=document.createElement('div');
    div.className='bubble '+(msg.from===myNumber?'sent':'rec');
    div.innerHTML=`<div>${msg.text}</div><div style="font-size:12px;color:#aaa">${msg.from} ‚Ä¢ ${msg.time}</div>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

// --- LOGIN FLOW ---
sendCodeBtn.onclick = ()=>{
  const num=numberInput.value.trim();
  if(!allowedNumbers.includes(num)) return alert("Number not allowed!");
  if(reports[num] && reports[num].count>=7 && Date.now()-reports[num].last<86400000){
    return alert("This number is banned for 24h due to multiple reports.");
  }
  myNumber=num;
  otherNumber=allowedNumbers.find(n=>n!==myNumber);
  verificationCode=Math.floor(1000+Math.random()*9000);
  alert("Your verification code: "+verificationCode);
  codeArea.classList.remove('hidden');
};

verifyBtn.onclick = ()=>{
  if(codeInput.value.trim()==verificationCode){
    if(!checkPIN()) return;
    loginStatus.textContent="Verified! Access granted.";
    saveSession(myNumber);
    loginArea.classList.add('hidden');
    chatArea.classList.remove('hidden');
    profileImg.src=profiles[otherNumber].photo;
    profileName.textContent=profiles[otherNumber].name;
    renderMessages();
    socket.emit('join', myNumber);
  }else{ alert("Incorrect code!"); }
};

// Auto-login
window.onload = ()=>{
  const session=loadSession();
  if(session && checkPIN()){
    if(reports[session.number] && reports[session.number].count>=7 && Date.now()-reports[session.number].last<86400000){
      alert("This number is banned for 24h due to multiple reports."); 
      localStorage.removeItem(STORAGE_KEY);
      return;
    }
    myNumber=session.number;
    otherNumber=allowedNumbers.find(n=>n!==myNumber);
    loginArea.classList.add('hidden');
    chatArea.classList.remove('hidden');
    profileImg.src=profiles[otherNumber].photo;
    profileName.textContent=profiles[otherNumber].name;
    renderMessages();
    socket.emit('join', myNumber);
  }
  if(Notification.permission!=="granted"){ Notification.requestPermission(); }
};

// --- MESSAGING ---
sendBtn.onclick = ()=>{
  if(blocked){ return alert("You blocked this number."); }
  const txt=messageInput.value.trim();
  if(!txt) return;
  const msg={from:myNumber,to:otherNumber,text:txt,time:new Date().toLocaleTimeString()};
  const msgs=loadMessages();
  msgs.push(msg);
  saveMessages(msgs);
  renderMessages();
  socket.emit('message',msg);
  messageInput.value='';
};
messageInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')sendBtn.click();});

socket.on('message', msg=>{
  if(blocked) return;
  const msgs=loadMessages();
  msgs.push(msg);
  saveMessages(msgs);
  renderMessages();
  if(msg.from!==myNumber){
    textTone.play();
    if(Notification.permission==="granted"){
      new Notification("New Message",{body:msg.text,icon:profiles[msg.from]?.photo});
    }
  }
});

// --- OPTIONS ---
uploadPhoto.onchange = (e)=>{
  const file = e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=()=>{
      profiles[myNumber].photo=reader.result;
      profileImg.src=reader.result;
      alert("Profile photo updated!");
    };
    reader.readAsDataURL(file);
  }
};
deleteAllBtn.onclick = ()=>{
  if(confirm("Delete all your local messages?")){
    saveMessages([]);
    renderMessages();
  }
};
blockBtn.onclick = ()=>{
  blocked=!blocked;
  blockBtn.textContent = blocked?"‚úÖ Unblock":"üö´ Block";
  alert(blocked?"You blocked this number.":"You unblocked this number.");
};
reportBtn.onclick = ()=>{
  if(!reports[otherNumber]) reports[otherNumber]={count:0,last:0};
  reports[otherNumber].count++;
  reports[otherNumber].last=Date.now();
  localStorage.setItem("reports", JSON.stringify(reports));
  alert("Report submitted. Total reports: "+reports[otherNumber].count);
};

// --- CALLS ---
callBtn.onclick = ()=>{
  if(inCall){ alert("Already in call"); return;}
  if(blocked){ return alert("You blocked this number."); }
  callStatus.classList.remove('hidden');
  callStatus.textContent="Calling...";
  socket.emit('call',{to:otherNumber});
};
endCallBtn.onclick = ()=>{
  if(!inCall) return;
  inCall=false;
  callStatus.textContent="Call ended";
  socket.emit('declineCall',{to:otherNumber});
  setTimeout(()=> callStatus.classList.add('hidden'),2000);
};
muteBtn.onclick = ()=>{muted=!muted;muteBtn.textContent=muted?"üîà Unmute":"üîá Mute";};
speakerBtn.onclick = ()=>{speaker=!speaker;speakerBtn.textContent=speaker?"üì¢ Normal":"üîä Speaker";};

socket.on('incomingCall', data=>{
  if(blocked) return;
  ringTone.play();
  if(Notification.permission==="granted"){
    new Notification("Incoming Call",{body:`From ${data.from}`,icon:profiles[data.from]?.photo});
  }
  callStatus.classList.remove('hidden');
  callStatus.innerHTML=`Incoming call from ${data.from}<br>
    <button onclick="answerCall()">Answer</button>
    <button onclick="declineCall()">Decline</button>`;
});
function answerCall(){
  inCall=true;
  ringTone.pause(); ringTone.currentTime=0;
  callStatus.textContent="Call connected";
  socket.emit('answerCall',{to:otherNumber});
}
function declineCall(){
  ringTone.pause(); ringTone.currentTime=0;
  callStatus.textContent="Call declined";
  socket.emit('declineCall',{to:otherNumber});
  setTimeout(()=> callStatus.classList.add('hidden'),2000);
}
socket.on('callAnswered', data=>{
  inCall=true;
  callStatus.textContent="Call connected with "+data.from;
});
socket.on('callDeclined', data=>{
  ringTone.pause(); ringTone.currentTime=0;
  callStatus.textContent="Call declined by "+data.from;
  setTimeout(()=> callStatus.classList.add('hidden'),2000);
});
</script>
</body>
</html>
