<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2-Number Live Chat & Call</title>
  <style>
    body{font-family: Arial,sans-serif; display:flex; justify-content:center; background:#0c1515; color:white; padding:20px;}
    .container{width:600px; background:#1a1f22; padding:20px; border-radius:10px;}
    .hidden{display:none;}
    input, button{padding:8px; margin:5px 0; width:100%; border-radius:5px; border:none;}
    #chatBox{height:300px; background:#111; overflow:auto; padding:10px; border-radius:5px; margin-bottom:10px; display:flex; flex-direction:column;}
    .bubble{padding:8px 12px; border-radius:8px; margin:5px 0; max-width:70%;}
    .sent{background:#25D366; color:#000; align-self:flex-end;}
    .rec{background:#fff; color:#000; align-self:flex-start;}
    .header{display:flex; align-items:center; margin-bottom:10px;}
    .header img{width:40px; height:40px; border-radius:50%; margin-right:10px;}
    .callStatus{margin:5px 0; color:#0f0;}
    .chat-controls{display:flex; gap:5px;}
    .chat-controls input{flex:1;}
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="container">

  <div id="loginArea">
    <h3>Login with your number</h3>
    <input type="text" id="numberInput" placeholder="Enter your number"/>
    <button id="sendCodeBtn">Send Code</button>
    <div id="codeArea" class="hidden">
      <input type="text" id="codeInput" placeholder="Enter code"/>
      <button id="verifyBtn">Verify</button>
    </div>
    <div id="loginStatus"></div>
  </div>

  <div id="chatArea" class="hidden">
    <div class="header">
      <img id="profileImg" src="" alt="Profile"/>
      <div>
        <div id="profileName"></div>
        <small>Online</small>
      </div>
    </div>
    <div id="chatBox"></div>

    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Type message..."/>
      <button id="sendBtn">Send</button>
      <button id="recordBtn">ðŸŽ¤</button>
      <button id="callBtn">ðŸ“ž</button>
    </div>
    <div id="callStatus" class="callStatus hidden"></div>
  </div>

</div>

<script>
const socket = io();
const allowedNumbers = ['13058962443','18573917861'];
const profiles = {
  "13058962443": {name:"My Wife", photo:"https://via.placeholder.com/40x40?text=W"},
  "18573917861": {name:"Me", photo:"https://via.placeholder.com/40x40?text=Me"}
};
let myNumber = null;
let verificationCode = null;
let otherNumber = null;

const loginArea = document.getElementById('loginArea');
const codeArea = document.getElementById('codeArea');
const loginStatus = document.getElementById('loginStatus');
const numberInput = document.getElementById('numberInput');
const sendCodeBtn = document.getElementById('sendCodeBtn');
const codeInput = document.getElementById('codeInput');
const verifyBtn = document.getElementById('verifyBtn');

const chatArea = document.getElementById('chatArea');
const chatBox = document.getElementById('chatBox');
const profileImg = document.getElementById('profileImg');
const profileName = document.getElementById('profileName');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const callBtn = document.getElementById('callBtn');
const callStatus = document.getElementById('callStatus');
const recordBtn = document.getElementById('recordBtn');

// Step1: send code
sendCodeBtn.onclick = ()=>{
  const num = numberInput.value.trim();
  if(!allowedNumbers.includes(num)) return alert("Number not allowed!");
  myNumber = num;
  otherNumber = allowedNumbers.find(n=>n!==myNumber);
  verificationCode = Math.floor(1000+Math.random()*9000);
  alert("Your verification code: "+verificationCode);
  codeArea.classList.remove('hidden');
}

// Step2: verify code
verifyBtn.onclick = ()=>{
  if(codeInput.value.trim()==verificationCode){
    loginStatus.textContent="Verified! Access granted.";
    loginArea.classList.add('hidden');
    chatArea.classList.remove('hidden');
    profileImg.src = profiles[otherNumber].photo;
    profileName.textContent = profiles[otherNumber].name;
    socket.emit('join', myNumber);
  }else{ alert("Incorrect code!"); }
}

// Step3: send message
sendBtn.onclick = ()=>{
  const txt = messageInput.value.trim();
  if(!txt) return;
  const msg = {to: otherNumber,text: txt};
  socket.emit('message', msg);
  messageInput.value='';
}

messageInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')sendBtn.click();});

// Receive text messages
socket.on('message', msg=>{
  const div = document.createElement('div');
  div.className='bubble '+(msg.from===myNumber?'sent':'rec');
  div.innerHTML=`<div>${msg.text}</div><div style="font-size:10px;color:#aaa">${msg.from} â€¢ ${msg.time}</div>`;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Load previous messages
socket.on('loadMessages', msgs=>{
  msgs.forEach(msg=>{
    const div = document.createElement('div');
    div.className='bubble '+(msg.from===myNumber?'sent':'rec');
    div.innerHTML=`<div>${msg.text}</div><div style="font-size:10px;color:#aaa">${msg.from} â€¢ ${msg.time}</div>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Voice recording
let mediaRecorder;
let audioChunks = [];
recordBtn.onclick = async ()=>{
  if(!mediaRecorder || mediaRecorder.state==="inactive"){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(audioChunks, {type:'audio/webm'});
      audioChunks=[];
      const reader = new FileReader();
      reader.onloadend = ()=>{
        socket.emit('voice', {to:otherNumber, audio:reader.result});
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    recordBtn.textContent="â¹";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent="ðŸŽ¤";
  }
};

// Receive voice
socket.on('voice', msg=>{
  const audio = document.createElement('audio');
  audio.controls = true;
  audio.src = msg.audio;
  const div = document.createElement('div');
  div.className='bubble '+(msg.from===myNumber?'sent':'rec');
  div.appendChild(audio);
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Call
callBtn.onclick = ()=>{
  callStatus.classList.remove('hidden');
  callStatus.textContent="Calling...";
  socket.emit('call', {to:otherNumber});
};

// Incoming call
socket.on('incomingCall', data=>{
  callStatus.classList.remove('hidden');
  callStatus.innerHTML=`Incoming call from ${data.from}<br>
    <button onclick="answerCall()">Answer</button>
    <button onclick="declineCall()">Decline</button>`;
});

// Answer / Decline
function answerCall(){
  callStatus.textContent="Call connected";
  socket.emit('answerCall', {to:otherNumber});
}
function declineCall(){
  callStatus.textContent="Call declined";
  socket.emit('declineCall', {to:otherNumber});
  setTimeout(()=> callStatus.classList.add('hidden'),2000);
}

socket.on('callAnswered', data=>{
  callStatus.textContent="Call connected with "+data.from;
});
socket.on('callDeclined', data=>{
  callStatus.textContent="Call declined by "+data.from;
  setTimeout(()=> callStatus.classList.add('hidden'),2000);
});
</script>
</body>
</html>
