<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2-Number Live Chat & Call</title>
<style>
body{font-family: Arial,sans-serif; display:flex; justify-content:center; background:#0c1515; color:white; padding:20px;}
.container{width:600px; background:#1a1f22; padding:20px; border-radius:10px;}
.hidden{display:none;}
input, button{padding:8px; margin:5px 0; width:100%; border-radius:5px; border:none;}
#chatBox{height:300px; background:#111; overflow:auto; padding:10px; border-radius:5px; margin-bottom:10px;}
.bubble{padding:8px 12px; border-radius:8px; margin:5px 0; max-width:70%;}
.sent{background:#25D366; color:#000; align-self:flex-end;}
.rec{background:#fff; color:#000; align-self:flex-start;}
.callStatus{margin:5px 0; color:#0f0;}
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="container">

  <div id="loginArea">
    <h3>Login with your number</h3>
    <input type="text" id="numberInput" placeholder="Enter your number"/>
    <button id="sendCodeBtn">Send Code</button>
    <div id="codeArea" class="hidden">
      <input type="text" id="codeInput" placeholder="Enter code"/>
      <button id="verifyBtn">Verify</button>
    </div>
    <div id="loginStatus"></div>
  </div>

  <div id="chatArea" class="hidden">
    <h3>Chat - Number: <span id="currentNumber"></span></h3>
    <div id="chatBox"></div>
    <input type="text" id="messageInput" placeholder="Type message..."/>
    <button id="sendBtn">Send</button>
    <button id="callBtn">ðŸ“ž Call</button>
    <div id="callStatus" class="callStatus hidden">Calling...</div>
  </div>

</div>

<script>
const socket = io();
const allowedNumbers = ['13058962443','18573917861'];
let myNumber = null;
let verificationCode = null;

const loginArea = document.getElementById('loginArea');
const codeArea = document.getElementById('codeArea');
const loginStatus = document.getElementById('loginStatus');
const numberInput = document.getElementById('numberInput');
const sendCodeBtn = document.getElementById('sendCodeBtn');
const codeInput = document.getElementById('codeInput');
const verifyBtn = document.getElementById('verifyBtn');

const chatArea = document.getElementById('chatArea');
const chatBox = document.getElementById('chatBox');
const currentNumber = document.getElementById('currentNumber');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const callBtn = document.getElementById('callBtn');
const callStatus = document.getElementById('callStatus');

// Step1: send code
sendCodeBtn.onclick = ()=>{
  const num = numberInput.value.trim();
  if(!allowedNumbers.includes(num)) return alert("Number not allowed!");
  myNumber = num;
  verificationCode = Math.floor(1000+Math.random()*9000);
  alert("Your verification code: "+verificationCode);
  codeArea.classList.remove('hidden');
}

// Step2: verify code
verifyBtn.onclick = ()=>{
  if(codeInput.value.trim()==verificationCode){
    loginStatus.textContent="Verified! Access granted.";
    loginArea.classList.add('hidden');
    chatArea.classList.remove('hidden');
    currentNumber.textContent=myNumber;
    socket.emit('join', myNumber);
  }else{ alert("Incorrect code!"); }
}

// Step3: send message
sendBtn.onclick = ()=>{
  const txt = messageInput.value.trim();
  if(!txt) return;
  const otherNumber = allowedNumbers.find(n=>n!==myNumber);
  const msg = {to: otherNumber,text: txt};
  socket.emit('message', msg);
  messageInput.value='';
}

// Receive messages
socket.on('message', msg=>{
  const div = document.createElement('div');
  div.className='bubble '+(msg.from===myNumber?'sent':'rec');
  div.innerHTML=`<div>${msg.text}</div><div style="font-size:10px;color:#aaa">${msg.from} â€¢ ${msg.time}</div>`;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Load previous messages
socket.on('loadMessages', msgs=>{
  msgs.forEach(msg=> socket.emit('message', msg));
});

// Call simulation
callBtn.onclick = ()=>{
  callStatus.classList.remove('hidden');
  callStatus.textContent="Calling...";
  socket.emit('call');
}

// Incoming call
socket.on('incomingCall', data=>{
  callStatus.classList.remove('hidden');
  callStatus.textContent="Incoming call from "+data.from;
  setTimeout(()=> callStatus.textContent="Call connected",1000);
  setTimeout(()=> callStatus.textContent="Call ended",5000);
  setTimeout(()=> callStatus.classList.add('hidden'),6000);
});

messageInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')sendBtn.click();});
</script>
</body>
</html>
