<!DOCTYPE html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2-Number Chat & Call (Video + History)</title>
<link rel="stylesheet" href="./style.css" />
<style>
/* Senp estil ki imite WhatsApp-like view */
:root{--bg:#f2efe9;--accent:#25D366;--dark:#0c1515}
html,body{height:100%;margin:0;font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;color:#111;}
.app{height:100%;display:flex;flex-direction:column;background:var(--bg) center/cover no-repeat;}
.topbar{background:linear-gradient(180deg,#0b0f0f, #172025);color:#fff;padding:8px 12px;display:flex;align-items:center;gap:12px;}
.topbar .callpill{background:rgba(255,255,255,0.08);padding:6px 10px;border-radius:18px;display:flex;align-items:center;gap:8px;}
.topbar .callpill .dot{width:8px;height:8px;border-radius:50%;background:#00ff6a;box-shadow:0 0 8px #00ff6a;}
.headerRow{display:flex;align-items:center;gap:10px}
.headerRow img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.12)}
.headerRow .name{font-weight:600}
.container{flex:1;display:flex;flex-direction:row;}

/* Chat column */
.chatcol{flex:1;display:flex;flex-direction:column;height:calc(100vh - 120px);background:transparent;padding:12px;overflow:hidden}
.chat-area{flex:1;overflow:auto;padding:18px;border-radius:12px;background:rgba(255,255,255,0.6);backdrop-filter:blur(4px);}
.bubble{max-width:70%;padding:10px 14px;border-radius:18px;margin:10px 0;font-size:15px;line-height:1.3}
.sent{align-self:flex-end;background:var(--accent);color:#000;}
.rec{align-self:flex-start;background:#fff;color:#000;}
.inputRow{display:flex;gap:8px;padding:10px 6px;align-items:center}
.inputRow input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;font-size:16px}

/* Right column: video + options */
.sidecol{width:340px;padding:12px;display:flex;flex-direction:column;gap:10px}
.preview{height:220px;background:#000;border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.preview video{width:100%;height:100%;object-fit:cover}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.small{font-size:13px;padding:8px;border-radius:8px;border:none;cursor:pointer}
.iconBtn{background:#fff;padding:8px;border-radius:8px}

/* history list */
.history{background:rgba(255,255,255,0.9);padding:8px;border-radius:8px;max-height:220px;overflow:auto}
.history .item{padding:6px;border-bottom:1px solid #eee;font-size:14px}

/* file input hidden style */
#bgInput{display:none}
.bgThumb{height:40px;width:40px;border-radius:6px;object-fit:cover;border:1px solid #ddd}

/* responsive */
@media(max-width:900px){.sidecol{display:none}}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="callpill" id="callBanner" style="display:none">
      <div class="dot"></div>
      <div id="callBannerText">Voice call â€” In call â€¢ Tap to return</div>
    </div>
    <div style="flex:1;display:flex;align-items:center;gap:12px" id="headerMain">
      <div class="headerRow">
        <img id="cProfile" src="https://via.placeholder.com/80x80?text=P" alt="profile"/>
        <div>
          <div class="name" id="cName">Miâ€¦</div>
          <div style="font-size:13px;color:#9ad8a4" id="cStatus">online</div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="videoCallBtn" class="small iconBtn">ðŸ“¹</button>
      <button id="voiceCallBtn" class="small iconBtn">ðŸ“ž</button>
      <label for="bgInput" style="cursor:pointer" title="Change background">
        <img id="bgThumb" class="bgThumb" src="https://via.placeholder.com/40x40?text=BG"/>
      </label>
      <input id="bgInput" type="file" accept="image/*"/>
    </div>
  </div>

  <div class="container">
    <div class="chatcol">
      <div id="chatArea" class="chat-area"></div>

      <div class="inputRow">
        <input id="messageInput" placeholder="Type message..."/>
        <button id="sendBtn" class="small">Send</button>
        <button id="attachBtn" class="small">ðŸ“Ž</button>
      </div>
    </div>

    <div class="sidecol">
      <div class="preview" id="preview">
        <div id="noVideoLabel" style="color:#fff">No active video</div>
        <video id="remoteVideo" autoplay playsinline style="display:none"></video>
        <video id="localVideo" autoplay muted playsinline style="width:120px;height:90px;position:absolute;right:8px;bottom:8px;border-radius:8px;display:none"></video>
      </div>

      <div class="controls">
        <button id="toggleCamBtn" class="small">Toggle Camera</button>
        <button id="toggleCamVisBtn" class="small">Hide Self</button>
        <button id="endCallLocalBtn" class="small">End Call</button>
      </div>

      <div>
        <strong>Call history</strong>
        <div class="history" id="historyList"></div>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/**
 * Frontend JS: WebRTC signaling + UI + background + history
 * - Make sure server implements corresponding socket events.
 */

/* --- Setup --- */
const socket = io();
const allowedNumbers = ['13058962443','18573917861']; // same as server
let myNumber = null, otherNumber = allowedNumbers[1];
let peerConnection = null;
let localStream = null;
let inCall = false;
let isVideoCall = false;
let usingFrontCamera = true;
let selfHidden = false;

const chatArea = document.getElementById('chatArea');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const bgInput = document.getElementById('bgInput');
const bgThumb = document.getElementById('bgThumb');
const videoCallBtn = document.getElementById('videoCallBtn');
const voiceCallBtn = document.getElementById('voiceCallBtn');
const remoteVideo = document.getElementById('remoteVideo');
const localVideo = document.getElementById('localVideo');
const noVideoLabel = document.getElementById('noVideoLabel');
const toggleCamBtn = document.getElementById('toggleCamBtn');
const toggleCamVisBtn = document.getElementById('toggleCamVisBtn');
const endCallLocalBtn = document.getElementById('endCallLocalBtn');
const historyList = document.getElementById('historyList');
const callBanner = document.getElementById('callBanner');
const callBannerText = document.getElementById('callBannerText');
const cProfile = document.getElementById('cProfile');
const cName = document.getElementById('cName');

/* storage keys */
const MSG_KEY = "chatAppMessages";
const CALLS_KEY = "chatAppCallHistory";
const STORAGE_KEY = "chatAppSession";
const PIN_KEY = "chatAppPIN";

/* helper: render messages */
function loadMessages(){ return JSON.parse(localStorage.getItem(MSG_KEY) || "[]"); }
function saveMessages(m){ localStorage.setItem(MSG_KEY, JSON.stringify(m)); }
function renderMessages(){ chatArea.innerHTML=''; const msgs=loadMessages(); msgs.forEach(m=>{ const d=document.createElement('div'); d.className='bubble '+(m.from===myNumber?'sent':'rec'); d.innerHTML=`${m.text}<div style="font-size:12px;color:#666;margin-top:6px">${m.from} â€¢ ${m.time}</div>`; chatArea.appendChild(d); }); chatArea.scrollTop=chatArea.scrollHeight; }

/* call history local */
function loadCalls(){ return JSON.parse(localStorage.getItem(CALLS_KEY) || "[]"); }
function saveCalls(c){ localStorage.setItem(CALLS_KEY, JSON.stringify(c)); }
function renderCalls(){ historyList.innerHTML=''; const cs=loadCalls(); cs.slice().reverse().forEach(it=>{ const el=document.createElement('div'); el.className='item'; el.textContent = `${it.type.toUpperCase()} â€¢ ${it.with} â€¢ ${it.start} â†’ ${it.end} â€¢ ${it.durationMinutes} min`; historyList.appendChild(el); }); }

/* timestamps */
function nowStr(){ return new Date().toLocaleString(); }

/* --- simple login auto for demo --- */
function quickLogin(num){
  myNumber = num;
  otherNumber = allowedNumbers.find(n=>n!==myNumber);
  // set profile (demo)
  cProfile.src = "https://via.placeholder.com/80x80?text=P";
  cName.textContent = "Miâ€¦";
  renderMessages();
  renderCalls();
  socket.emit('join', myNumber);
}
quickLogin(allowedNumbers[1]); // auto-login demo (you can add real login UI)

/* --- messaging --- */
sendBtn.onclick = ()=>{
  const txt = messageInput.value.trim();
  if(!txt) return;
  const m = {from: myNumber, to: otherNumber, text: txt, time: new Date().toLocaleTimeString()};
  const msgs = loadMessages(); msgs.push(m); saveMessages(msgs); renderMessages();
  socket.emit('message', m);
  messageInput.value='';
};
socket.on('message', msg=>{
  const msgs = loadMessages(); msgs.push(msg); saveMessages(msgs); renderMessages();
});

/* --- background image upload --- */
bgInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    document.querySelector('.app').style.backgroundImage = `url(${r.result})`;
    bgThumb.src = r.result;
  };
  r.readAsDataURL(f);
});

/* --- WebRTC helpers --- */
const pcConfig = { iceServers:[{urls:'stun:stun.l.google.com:19302'}] };

async function startLocalStream(video){
  const constraints = { audio:true, video: video ? { facingMode: usingFrontCamera ? "user" : "environment" } : false };
  localStream = await navigator.mediaDevices.getUserMedia(constraints);
  if(video){
    localVideo.srcObject = localStream;
    localVideo.style.display = selfHidden ? 'none' : 'block';
  }
  return localStream;
}

function makePeerConnection(){
  peerConnection = new RTCPeerConnection(pcConfig);
  peerConnection.onicecandidate = (e)=> { if(e.candidate) socket.emit('webrtc-ice',{to:otherNumber,candidate:e.candidate}); };
  peerConnection.ontrack = (e)=> {
    remoteVideo.srcObject = e.streams[0];
    remoteVideo.style.display = 'block';
    noVideoLabel.style.display = 'none';
  };
}

/* start outgoing call (voice or video) */
async function startCall(video){
  isVideoCall = !!video;
  await startLocalStream(video);
  makePeerConnection();
  // add tracks
  localStream.getTracks().forEach(t=>peerConnection.addTrack(t, localStream));
  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  socket.emit('webrtc-offer',{to:otherNumber,offer});
  inCall = true;
  callBanner.style.display='flex';
  callBannerText.textContent = video ? "Video call â€” calling..." : "Voice call â€” calling...";
  callStartTime = Date.now();
}

/* end call */
function endCallLocal(){
  if(!inCall) return;
  socket.emit('endCall',{to:otherNumber});
  cleanupCall(true);
}

/* cleanup local resources and store history */
function cleanupCall(endedByMe=false, remoteInfo){
  if(peerConnection){
    peerConnection.getSenders().forEach(s=>{try{s.track.stop();}catch(e){};});
    peerConnection.close(); peerConnection=null;
  }
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  remoteVideo.srcObject = null; remoteVideo.style.display='none';
  localVideo.srcObject = null; localVideo.style.display='none';
  noVideoLabel.style.display = 'block';
  callBanner.style.display='none';
  inCall = false;
  // store call history with duration
  const end = Date.now();
  const durationMs = Math.max(0, end - (window.callStartTime||end));
  const minutes = Math.round(durationMs / 60000 * 100) / 100; // two decimals
  const calls = loadCalls();
  calls.push({
    with: otherNumber,
    type: isVideoCall ? 'video' : 'voice',
    start: new Date((window.callStartTime)||end).toLocaleString(),
    end: new Date(end).toLocaleString(),
    durationMs,
    durationMinutes: minutes
  });
  saveCalls(calls);
  renderCalls();
  // notify server to persist
  socket.emit('callEndedRecord', {with: otherNumber, type: isVideoCall?'video':'voice', start: window.callStartTime||Date.now(), end});
}

/* toggle camera facing */
toggleCamBtn.onclick = async ()=>{
  usingFrontCamera = !usingFrontCamera;
  if(localStream){
    // restart video track
    localStream.getTracks().forEach(t=>t.stop());
    await startLocalStream(isVideoCall);
    // replace tracks on peer connection
    const videoTrack = localStream.getVideoTracks()[0];
    const sender = peerConnection && peerConnection.getSenders().find(s=>s.track && s.track.kind==='video');
    if(sender && videoTrack) sender.replaceTrack(videoTrack);
  }
  toggleCamBtn.textContent = usingFrontCamera ? 'Front' : 'Back';
};

/* hide/show self video */
toggleCamVisBtn.onclick = ()=>{
  selfHidden = !selfHidden;
  localVideo.style.display = selfHidden ? 'none' : 'block';
  toggleCamVisBtn.textContent = selfHidden ? 'Show Self' : 'Hide Self';
};

endCallLocalBtn.onclick = endCallLocal;

/* --- signalling events from server --- */
let callStartTime = null;

socket.on('webrtc-offer', async (data)=>{
  // incoming offer -> create pc, set remote desc, create answer
  isVideoCall = !!(data.offer.sdp && data.offer.sdp.includes('m=video'));
  await startLocalStream(isVideoCall);
  makePeerConnection();
  localStream.getTracks().forEach(t=>peerConnection.addTrack(t, localStream));
  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  socket.emit('webrtc-answer',{to:data.from,answer});
  inCall = true;
  callBanner.style.display='flex';
  callBannerText.textContent = isVideoCall ? "Video call â€” In call" : "Voice call â€” In call";
  window.callStartTime = Date.now();
});

socket.on('webrtc-answer', async (data)=>{
  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
  // call connected
  callStartTime = Date.now();
  callBannerText.textContent = isVideoCall ? "Video call â€” In call" : "Voice call â€” In call";
});

socket.on('webrtc-ice', async (data)=>{
  try{
    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
  }catch(e){}
});

socket.on('endCall', (data)=>{
  cleanupCall(false, data);
});

/* when remote hangs up, server sends 'endCall' */
socket.on('callEndedRecordAck', ()=>{/* server persisted record */});

/* --- outgoing buttons --- */
voiceCallBtn.onclick = ()=> startCall(false);
videoCallBtn.onclick = ()=> startCall(true);

/* track callStarted locally */
window.addEventListener('beforeunload', ()=>{ if(inCall) cleanupCall(true); });

/* toggle showing call banner click to return */
callBanner.onclick = ()=> window.scrollTo(0,0);

/* history UI initial */
renderCalls();

/* keep socket message handlers for chat & simple events */
socket.on('connect', ()=>{ console.log('socket connected'); });

</script>
</body>
</html>
