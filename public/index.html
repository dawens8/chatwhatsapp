<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2-Number Live Chat & Call</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      font-family: Arial, sans-serif;
      background: #0c1515;
      color: white;
    }
    .container {
      width: 90%; max-width: 1000px;
      height: 90%; margin: auto;
      background: #1a1f22;
      padding: 20px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    .hidden{display:none;}
    input, button{padding:12px; margin:5px 0; border-radius:8px; border:none; font-size:16px;}
    #chatBox{
      flex:1;
      background:#111;
      overflow:auto;
      padding:15px;
      border-radius:8px;
      margin-bottom:10px;
      display:flex; flex-direction:column;
    }
    .bubble{
      padding:12px 16px;
      border-radius:12px;
      margin:8px 0;
      max-width:75%;
      font-size:18px;
      line-height:1.4;
    }
    .sent{background:#25D366; color:#000; align-self:flex-end;}
    .rec{background:#fff; color:#000; align-self:flex-start;}
    .header{
      display:flex;
      align-items:center;
      margin-bottom:15px;
    }
    .header img{
      width:60px; height:60px;
      border-radius:50%;
      margin-right:15px;
    }
    .callStatus{margin:10px 0; color:#0f0; font-size:18px;}
    .chat-controls{
      display:flex; gap:10px;
    }
    .chat-controls input{flex:1;}
    button{cursor:pointer; font-weight:bold;}
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="container">

  <div id="loginArea">
    <h2>Login with your number</h2>
    <input type="text" id="numberInput" placeholder="Enter your number"/>
    <button id="sendCodeBtn">Send Code</button>
    <div id="codeArea" class="hidden">
      <input type="text" id="codeInput" placeholder="Enter code"/>
      <button id="verifyBtn">Verify</button>
    </div>
    <div id="loginStatus"></div>
  </div>

  <div id="chatArea" class="hidden">
    <div class="header">
      <img id="profileImg" src="" alt="Profile"/>
      <div>
        <div id="profileName" style="font-size:22px;font-weight:bold;"></div>
        <small style="font-size:16px;">Online</small>
      </div>
    </div>
    <div id="chatBox"></div>

    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Type message..."/>
      <button id="sendBtn">Send</button>
      <button id="recordBtn">ðŸŽ¤</button>
      <button id="callBtn">ðŸ“ž</button>
    </div>
    <div id="callStatus" class="callStatus hidden"></div>
  </div>

</div>

<script>
const socket = io();
const allowedNumbers = ['13058962443','18573917861'];
const profiles = {
  "13058962443": {name:"My Wife", photo:"https://via.placeholder.com/60x60?text=W"},
  "18573917861": {name:"Me", photo:"https://via.placeholder.com/60x60?text=Me"}
};
let myNumber = null;
let verificationCode = null;
let otherNumber = null;

const loginArea = document.getElementById('loginArea');
const codeArea = document.getElementById('codeArea');
const loginStatus = document.getElementById('loginStatus');
const numberInput = document.getElementById('numberInput');
const sendCodeBtn = document.getElementById('sendCodeBtn');
const codeInput = document.getElementById('codeInput');
const verifyBtn = document.getElementById('verifyBtn');

const chatArea = document.getElementById('chatArea');
const chatBox = document.getElementById('chatBox');
const profileImg = document.getElementById('profileImg');
const profileName = document.getElementById('profileName');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const callBtn = document.getElementById('callBtn');
const callStatus = document.getElementById('callStatus');
const recordBtn = document.getElementById('recordBtn');

// Step1: send code
sendCodeBtn.onclick = ()=>{
  const num = numberInput.value.trim();
  if(!allowedNumbers.includes(num)) return alert("Number not allowed!");
  myNumber = num;
  otherNumber = allowedNumbers.find(n=>n!==myNumber);
  verificationCode = Math.floor(1000+Math.random()*9000);
  alert("Your verification code: "+verificationCode);
  codeArea.classList.remove('hidden');
}

// Step2: verify code
verifyBtn.onclick = ()=>{
  if(codeInput.value.trim()==verificationCode){
    loginStatus.textContent="Verified! Access granted.";
    loginArea.classList.add('hidden');
    chatArea.classList.remove('hidden');
    profileImg.src = profiles[otherNumber].photo;
    profileName.textContent = profiles[otherNumber].name;
    socket.emit('join', myNumber);
  }else{ alert("Incorrect code!"); }
}

// Step3: send message
sendBtn.onclick = ()=>{
  const txt = messageInput.value.trim();
  if(!txt) return;
  const msg = {to: otherNumber,text: txt};
  socket.emit('message', msg);
  messageInput.value='';
}

messageInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')sendBtn.click();});

// Receive text messages
socket.on('message', msg=>{
  const div = document.createElement('div');
  div.className='bubble '+(msg.from===myNumber?'sent':'rec');
  div.innerHTML=`<div>${msg.text}</div><div style="font-size:12px;color:#aaa">${msg.from} â€¢ ${msg.time}</div>`;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Voice recording
let mediaRecorder;
let audioChunks = [];
recordBtn.onclick = async ()=>{
  if(!mediaRecorder || mediaRecorder.state==="inactive"){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(audioChunks, {type:'audio/webm'});
      audioChunks=[];
      const reader = new FileReader();
      reader.onloadend = ()=>{
        socket.emit('voice', {to:otherNumber, audio:reader.result});
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    recordBtn.textContent="â¹";
  } else {
    mediaRecorder.stop();
    recordBtn.textContent="ðŸŽ¤";
  }
};

// Receive voice
socket.on('voice', msg=>{
  const audio = document.createElement('audio');
  audio.controls = true;
  audio.src = msg.audio;
  const div = document.createElement('div');
  div.className='bubble '+(msg.from===myNumber?'sent':'rec');
  div.appendChild(audio);
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

// Call
callBtn.onclick = ()=>{
  callStatus.classList.remove('hidden');
  callStatus.textContent="Calling...";
  socket.emit('call', {to:otherNumber});
};

// Incoming call
socket.on('incomingCall', data=>{
  callStatus.classList.remove('hidden');
  callStatus.innerHTML=`Incoming call from ${data.from}<br>
    <button onclick="answerCall()">Answer</button>
    <button onclick="declineCall()">Decline</button>`;
});

// Answer / Decline
function answerCall(){
  callStatus.textContent="Call connected";
  socket.emit('answerCall', {to:otherNumber});
}
function declineCall(){
  callStatus.textContent="Call declined";
  socket.emit('declineCall', {to:otherNumber});
  setTimeout(()=> callStatus.classList.add('hidden'),2000);
}

socket.on('callAnswered', data=>{
  callStatus.textContent="Call connected with "+data.from;
});
socket.on('callDeclined', data=>{
  callStatus.textContent="Call declined by "+data.from;
  setTimeout(()=> callStatus.classList.add('hidden'),2000);
});
</script>
</body>
</html>
